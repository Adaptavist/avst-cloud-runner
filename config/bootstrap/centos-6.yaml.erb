---

pre_upload_commands:
    - yum -y update
    - yum install -y curl
    - curl -sSL https://raw.github.com/adaptavist/rvm/adaptavist_rvm/binscripts/rvm-installer | bash -s -- --version 1.25.33
    - source /usr/local/rvm/scripts/rvm; rvm install 2.0.0-p481
    - 'echo "gem: --no-ri --no-rdoc" > ~/.gemrc'
    - 'yum install -y git puppet-common puppet augeas-devel augeas unzip'
    - source /usr/local/rvm/scripts/rvm; gem install --no-ri --no-rdoc puppet -v 3.7.5 
    - source /usr/local/rvm/scripts/rvm; gem install --no-ri --no-rdoc r10k ruby-augeas hiera-eyaml hiera-fragment ruby-shadow
    - <%="echo 'HOSTNAME=#{fqdn}' >> /etc/sysconfig/network; sed -i '/127.0.1.1/d' /etc/hosts; echo '127.0.1.1 #{fqdn} #{server_name}' >> /etc/hosts; hostname #{fqdn};"%>
    - <%="if [ ! -f /usr/bin/hostnamectl ]; then  /etc/init.d/network restart; else /usr/bin/hostnamectl set-hostname  #{fqdn}; fi" %>
    - mount -t xfs | egrep ' / '.*.inode64 > /dev/null 2>&1 && (mount -o remount,inode32 /;mount -o remount,inode64 /)
    - source /usr/local/rvm/scripts/rvm; gem install --no-ri --no-rdoc puppet-runner
    - mkdir /root/.ssh
    - chmod 700 /root/.ssh
    <% unless as_user == 'root' %>
    - <% ssh_dir = "/home/#{as_user}/.ssh"%>
    - <%="mkdir #{ssh_dir}"%>
    - <%="chmod 700 #{ssh_dir}"%>
    - groupadd admin
    - <%="usermod -a -G admin #{as_user}"%>
    <%end%>
    - mkdir -p /var/opt/puppet/secure/keys
    - '<%="chown #{as_user}: /var/opt/puppet"%>'
    - chmod -R 0500 /var/opt/puppet/secure/keys

custom_file_uploads:
    "files/id_rsa": "/tmp/."
    "files/known_hosts": "/tmp/."
    "config/keys/private_key.pkcs7.pem": "/tmp/."
    "config/keys/public_key.pkcs7.pem": "/tmp/."

post_upload_commands:
    - "mv /tmp/private_key.pkcs7.pem /var/opt/puppet/secure/keys/."
    - "mv /tmp/public_key.pkcs7.pem /var/opt/puppet/secure/keys/."
    <% unless as_user == 'root' %>
    - <%= "cp /tmp/known_hosts /home/#{as_user}/.ssh/known_hosts" %>
    - <%= "cp /tmp/id_rsa /home/#{as_user}/.ssh/id_rsa" %>
    - '<%="chown #{as_user}: /home/#{as_user}/.ssh/known_hosts" %>'
    - '<%="chown #{as_user}: /home/#{as_user}/.ssh/id_rsa" %>'
    - <%= "chmod 0600 /home/#{as_user}/.ssh/known_hosts" %>
    - <%= "chmod 0600 /home/#{as_user}/.ssh/id_rsa" %>
    <%end%>
    - "mv /tmp/id_rsa /root/.ssh/."
    - "mv /tmp/known_hosts /root/.ssh/."
    - "chown root: /root/.ssh/known_hosts"
    - "chown root: /root/.ssh/id_rsa"
    - <%= "chmod 0600 /root/.ssh/known_hosts" %>
    - <%= "chmod 0600 /root/.ssh/id_rsa" %>

